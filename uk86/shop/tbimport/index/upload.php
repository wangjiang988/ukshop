<?php include 'tbconfig.php';global $tbconfig;if (isset($_FILES["Filedata"]) || !is_uploaded_file($_FILES["Filedata"]["tmp_name"]) || $_FILES["Filedata"]["error"] != 0) {	$path = $tbconfig['web_root'].trim($_POST['storeid']);	if(!file_exists($path)){mkdir($path,0777);}	$path = realpath($path).'/';	$filetype	 = '.jpg';	$upload_file = $_FILES['Filedata'];	$file_info   = pathinfo($upload_file['name']);	$sourimgname = $file_info['filename'];	$rukuimgname = trim($_POST['storeid']).'_'.$sourimgname.$filetype;	$save        = $path . $rukuimgname;	$name        = $_FILES['Filedata']['tmp_name'];	if (!move_uploaded_file($name, $save)) {exit;}	$fz60	= $path.trim($_POST['storeid']).'_'.$sourimgname.'_60.jpg';	$fz240	= $path.trim($_POST['storeid']).'_'.$sourimgname.'_240.jpg';	$fz360  = $path.trim($_POST['storeid']).'_'.$sourimgname.'_360.jpg';	$fz1280 = $path.trim($_POST['storeid']).'_'.$sourimgname.'_1280.jpg';	if(copy($save,$fz60)){				resizeimage($fz60,60,60, $fz60);	}	if(copy($save,$fz240)){			resizeimage($fz240,240,240, $fz240);	}	if(copy($save,$fz360)){				resizeimage($fz360,360,360, $fz360);	}	if(copy($save,$fz1280)){				resizeimage($fz1280,1280,1280, $fz1280);	}		$conn1 = mysql_connect($tbconfig['datahost'],$tbconfig['datausername'],$tbconfig['datauserpass'],true) or die('连接数据库失败');	mysql_select_db($tbconfig['databasename'],$conn1);$tablegoods   = $tbconfig['datatablepre'].'goods';$tablegoodscommon = $tbconfig['datatablepre'].'goods_common';$tablegoodsimages = $tbconfig['datatablepre'].'goods_images';	$tablealbum_pic   = $tbconfig['datatablepre'].'album_pic';$updategoodssql = "UPDATE $tablegoods SET goods_image='".$rukuimgname."' WHERE goods_image='".$sourimgname."'";	$updategoodscomsql = "UPDATE $tablegoodscommon SET goods_image='".$rukuimgname."' WHERE goods_image='".$sourimgname."'";$updategoodsimgsql = "UPDATE $tablegoodsimages SET goods_image='".$rukuimgname."' WHERE goods_image='".$sourimgname."'";$insertpic = "INSERT INTO $tablealbum_pic (apic_name,aclass_id,apic_cover,store_id) VALUES('".$sourimgname."','5','".$rukuimgname."','1')";	mysql_query($updategoodssql,$conn1) or die('更新goods表失败');	mysql_query($updategoodscomsql,$conn1) or die('更新common表失败');	mysql_query($updategoodsimgsql,$conn1) or die('更新images表失败');	mysql_query($insertpic,$conn1) or die('插入album_pic表失败');}function resizeimage($srcfile,$ratew='',$rateh='', $filename = "" ){	$size=getimagesize($srcfile);	switch($size[2]){		case 1:			$img=imagecreatefromgif($srcfile);			break;		case 2:			$img=imagecreatefromjpeg($srcfile);//从源文件建立一个新图片			break;		case 3:			$img=imagecreatefrompng($srcfile);			break;		default:			exit;	}	$srcw=imagesx($img);	echo '源文件的宽度'.$srcw.'<br />';	$srch=imagesy($img);	echo '源文件的高度'.$srch.'<br />';	$dstw=$ratew;	$dsth=$rateh;	echo '新图片的宽度'.$dstw.'高度'.$dsth.'<br />';	$im=imagecreatetruecolor($dstw,$dsth);	$black=imagecolorallocate($im,255,255,255);	imagefilledrectangle($im,0,0,$dstw,$dsth,$black);	imagecopyresized($im,$img,0,0,0,0,$dstw,$dsth,$srcw,$srch);	if( $filename ) {		imagejpeg($im, $filename ,100);	}	imagedestroy($im);	imagedestroy($img);}